<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Tableware : d-touch Mobile - Part 1" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Tableware</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/horizon-institute/tableware">Fork Me on GitHub</a>

          <h1 id="project_title">Tableware</h1>
          <h2 id="project_tagline">d-touch Mobile - Part 3</h2>

          <section id="downloads">
            <a class="zip_download_link" href="https://github.com/horizon-institute/tableware/zipball/master">Download this project as a .zip file</a>
            <a class="tar_download_link" href="https://github.com/horizon-institute/tableware/tarball/master">Download this project as a tar.gz file</a>
          </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
	<div dir="ltr" style="text-align: left;" trbidi="on">
In our last two posts we discussed about <a href="http://horizoncloud.blogspot.co.uk/2012/04/d-touch-mobile-d-touch-markers-are.html">d-touch markers</a> and how<a href="http://horizoncloud.blogspot.co.uk/2012/04/d-touch-mobile-part-2.html"> d-touch mobile library</a> can be configured and used in an Android application. In this post we are going to discuss the architecture of the d-touch mobile library.<br />
<br />
There are three main entities or classes of the d-touch mobile library.<br />
<ol style="text-align: left;">
<li>HIPreference </li>
<li>DetectMarker</li>
<li>MarkerConstraint</li>
</ol>
The sequence diagram of these entities is shown in figure 1:<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-s0I5oDNMbgI/T4WcA-uaSZI/AAAAAAAAAns/_OGUorCsTLg/s1600/DtouchMobileSequenceDiagram.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://3.bp.blogspot.com/-s0I5oDNMbgI/T4WcA-uaSZI/AAAAAAAAAns/_OGUorCsTLg/s1600/DtouchMobileSequenceDiagram.jpg" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Figure 1: Sequence diagram of d-touch mobile library</td></tr>
</tbody></table>
<br />
<!--more--><br />
<br />
<a href="http://www.blogger.com/blogger.g?blogID=3059793433233142833" name="more"></a><br />
<h2 style="text-align: left;">






















HIPreference</h2>
<div style="text-align: left;">
This class is used to store preferences which are used to define the constraints for the d-touch markers. This class contains two sets of parameters. The first set defines the type of the d-touch markers which d-touch mobile library should detect. This set contains the following paramters:</div>
<ul style="text-align: left;">
<li>minium branches: It defines the minimum number of branches a d-touch marker can contain. </li>
<li>maximum branches: It defines the maximum number of branches a d-touch marker can contain.</li>
<li>empty branches: It defines the number of empty branches a d-touch marker can contain. A valid d-touch marker should at least have one non-empty branch.</li>
<li>maximum leaves: It defines the number of leaves a branch can contain.</li>
</ul>
These constraints are useful to restrict d-touch marker which should be recognised by an application. For example if we want to restrict our application to detect only those markers which have between 3 to 4 branches then we can set the minimum branches to 3 and the maximum branches to 4.&nbsp; <br />
<br />
The second set of parameters is used for validation. We use checksum for the validation. This set contains following parameters:<br />
<ul style="text-align: left;">
<li>Validation Branches: It defines the number of validation branches a marker should have.</li>
<li>Validation Branch leaves: This parameter defines the number of leaves a validation branch should contain.</li>
<li>Checksum Modulo: This parameter defines the checksum modulo.</li>
</ul>
In order to calculate the checksum of a d-touch marker code the program first verifies the number of validation branches in the code. It then adds all the leaves in all the branches including validation branches and divides the total by the checksum modulo parameter. If the total number of leaves is completely divisible by the checksum modulo then the marker is considered as valid. Lets take an example to clarify it. For example if the preferences are set as follows:<br />
<ul style="text-align: left;">
<li>Validation Branches: 4</li>
<li>Validation Branch leaves: 1</li>
<li>Checksum Modulo: 10</li>
</ul>
and for example our maker looks like as shown in figure 2:<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-Rw_JaZl7O18/T4WmLf1KU8I/AAAAAAAAAn0/UvL84igkFxQ/s1600/dotuchMarkerExample.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="163" src="http://4.bp.blogspot.com/-Rw_JaZl7O18/T4WmLf1KU8I/AAAAAAAAAn0/UvL84igkFxQ/s320/dotuchMarkerExample.png" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Figure 2: Dtouch marker with validation branches.</td></tr>
</tbody></table>
As you can see from figure 2 that the marker has total eight branches among which four branches have exactly one leaf. So there are four validation branches in this marker. Now if we count the total number of leaves in this marker we get the result as 20. If we divide the total number of leaves i.e. 20 by the checksum modulo which is 10 then we get the result as 2.&nbsp; This means that the marker shown in figure 2 is a valid marker.<br />
<br />
<h2 style="text-align: left;">
















DetectMarker</h2>
<div style="text-align: left;">
This class is used to check if the given nodes represent a valid d-touch marker. A valid d-touch marker has one dark region and is called root. The root region has one or more light region and these light regions are referred as branches. Each branch node can have zero or more dark regions. The dark regions inside branches are called leaves. Marker in figure 2 is a valid d-touch marker. For more information about the d-touch marker please refer to <a href="http://horizoncloud.blogspot.co.uk/2012/04/d-touch-mobile-d-touch-markers-are.html">d-touch Mobile Part 1</a> blog. <br />
<br />
<h3 style="text-align: left;">
















verifyRoot </h3>
As shown in figure 1, an external module calls verifyRoot function to check if the node represents a valid d-touch marker root node. A node is a valid root if it has one or more valid branches and each branch has zero or more valid leaves. A root node should also fulfills the constraints defined in the preference class.&nbsp; <br />
<br />
This function receives following parameters:</div>
<ul style="text-align: left;">
<li>rootIndex: This is the index of the node which we want to test as the root of the d-touch marker.</li>
<li>rootNode: This points to the root node.</li>
<li>hierarchy: This contains the hierarchy of the nodes in the image. It is used to trace root node, branches and their leaves.</li>
<li>codes: This is an empty list and if a marker is valid then the verifyRoot function fills the code of that marker in this list.</li>
</ul>
One question which might come into mind would be how to get the parameter values which are required as an input to the verifyRoot function? As we have mentioned in our previous post that we use OpenCV to process images. In order to get the values for above parameters we use OpenCV function called findContours. This function is called as follows:<br />
<pre>Imgproc.findContours(contourImg, mComponents, mHierarchy, Imgproc.RETR_TREE, Imgproc.CHAIN_APPROX_NONE);
</pre>
findCountours function finds contours or regions in the image and returns the list of regions in the components parameter and the whole hierarchy in the hierarchy parameter. For more information please refer to the OpenCV documentation.<br />
After getting the list of components we iterate through this list and test each component for a valid d-touch marker root node. The implementation is as follows:<br />
<pre>    for (int i = 0; i &lt; mComponents.size(); i++){
      //clean this list.
      code.clear();
      if (markerDetector.verifyRoot(i, mComponents.get(i), mHierarchy,code)){
       //if marker found.
       marker.setCode(code);
       //marker.setComponent(mComponents.get(i));
       marker.setComponentIndex(i);
       markerFound = true;
       break;
      }
 }
</pre>
In this code we iterate through the list of components which is determined through findContours function. We check if a particular component is a valid d-touch marker through verifyRoot function. Now lets see the logic behind verifyRoot function. 
<br />
<pre> 
public Boolean verifyRoot(int rootIndex, Mat rootNode, Mat hierarchy, List&lt;integer&gt; codes){
  Boolean valid = false;
  int branchCount = 0;
  int emptyBranchCount = 0;
  int currentBranchIndex = -1;
  BranchStatus status;
    
  //get the nodes of the root node.
  double[] nodes = hierarchy.get(0, rootIndex);
  //get the first child node.
  currentBranchIndex = (int)nodes[FIRST_NODE];

  //if there is a branch node then verify branches.
  if (currentBranchIndex &gt;= 0 ){
   //loop until there is a branch node.
   while(currentBranchIndex &gt;= 0){
    //verify current branch.
    status = verifyBranch(currentBranchIndex, hierarchy, codes);
    //if branch is valid or empty.
    if (status == BranchStatus.VALID || status == BranchStatus.EMPTY ){
     branchCount++;
     if (status == BranchStatus.EMPTY){
      emptyBranchCount++;
      if (emptyBranchCount &gt; mPreference.getMaxEmptyBranches()){
       return false;
      }
     }
     //get next node. 
     nodes = hierarchy.get(0, currentBranchIndex);
     currentBranchIndex = (int)nodes[NEXT_NODE];
    }
    else if (status == BranchStatus.INVALID)
     return false;
   }
   if (emptyBranchCount &gt; mPreference.getMaxEmptyBranches())
    valid = false;
   //Marker should have at least one non-empty branch. If all branches are empty then return false.
   else if ((emptyBranchCount - branchCount) == 0)
    valid = false;
   else if (branchCount &gt;= mPreference.getMinBranches() &amp;&amp; branchCount &lt;= mPreference.getMaxBranches()){
    if (verifyMarkerConstraint(codes)){
     Collections.sort(codes);
     valid = true;
    }else
     valid = false;
   }
  }
  return valid;
 }
</pre>
This function first gets the immediate hierarchy of the root node. From this immediate hierarchy it retrieves the first child node of the root node. In the while loop it verifies if the current child node is a valid branch. If it is a valid branch or an empty branch then it increases the branch counter. If it is an empty branch then it also increases the empty branch counter. Please note that an empty branch is also a valid branch but it is not true vice versa. It then gets the next sibling of the current branch node and runs the same process again. After all the child nodes are verified as valid branches it verifies the marker against the constraints defined in the preferences. If&nbsp; during the verification process a branch is identified as an invalid then the process stops and the root is considered as an invalid d-touch marker.<br />
<br />
<h3 style="text-align: left;">









verifyBranch</h3>
<div style="text-align: left;">
verifyBranch function is called from verifyRoot function to check if a particular node is a valid branch. A node is a valid branch if it has zero or more valid leaves. A valid branch should also fulfills the constrainsts defined in the preference class. In order to validate a node as a valid branch it checks if its child nodes are valid leaves. It then verifies the branch against constraints defined in the preferences class. In case of valid branch the total number of leaves in this valid branch are added in the code list as part of the code. </div>
<pre>private BranchStatus verifyBranch(int branchIndex, Mat hierarchy, List&lt;integer&gt; codes){
  int leafCount = 0;
  int currentLeafIndex = -1;
  BranchStatus status = BranchStatus.INVALID;
  
  //get first leaf node.
  double[] nodes = hierarchy.get(0, branchIndex);
  currentLeafIndex = (int)nodes[FIRST_NODE];
  if (currentLeafIndex &gt;= 0){
   //loop until there is a leaf node.
   while(currentLeafIndex &gt;= 0){
    if (verifyLeaf(currentLeafIndex, hierarchy)){
     leafCount++;
     //get next leaf node.
     nodes = hierarchy.get(0, currentLeafIndex);
     currentLeafIndex = (int)nodes[NEXT_NODE];
    }else{
     status = BranchStatus.INVALID;
     return status;
    }
   }
  }
  //if no leaf then the branch is empty.
  if (leafCount == 0)
   status = BranchStatus.EMPTY;
  else if (leafCount &lt;= mPreference.getMaxLeaves())
   status = BranchStatus.VALID;
  //add leaf count in branch code. Only add it when leaf count is greater than 0.
  if(leafCount &gt; 0 ) 
   codes.add(leafCount);
  return status;
 }
</pre>
This function retreives the hierarchy of the current branch node. It then retreives the first child node and checks if it a valid leaf. If the child node is valid leaf then it increase the leaf count. If the leaf node is invalid then the branch is considered as an invalid. After all the child nodes of a branch node are verified as leaves this process verifies the branch against the constraints defined in the preferences class. If the branch validation is successful then the total number of leaves in a branch are added in the code list. <br />
<br />
<h3 style="text-align: left;">








verifyLeaf</h3>
<div style="text-align: left;">
This function is called from the verifyBranch function to check if a particular node is a valid leaf. A node is a valid leaf if it does not have any child nodes. The implementation of this function is very simple:</div>
<div style="text-align: left;">
&nbsp; </div>
<pre> private Boolean verifyLeaf(int leafIndex, Mat hierarchy){
  Boolean valid = true;
  //Get nodes of branch index.
  double[] nodes = hierarchy.get(0, leafIndex);
  //check if there is no child node.
  if (nodes[FIRST_NODE] &gt;= 0){
   valid = false;
  } 
  return valid;
 }
</pre>
It simply checks if there are any child nodes of this node. If there are no child nodes then it returns true otherwise it returns false.<br />
<br />
<h2 style="text-align: left;">







MarkerConstraint</h2>
<div style="text-align: left;">
This class is used to verify the d-touch code against the validation constraints defined in the preference class. We have discussed the validation constraints in the HIPreference section. This class is called from verifyRoot function to validate the marker code against the validation constraint. The verification is done by calling the verifyMarkerCode function.</div>
<div style="text-align: left;">
<br /></div>
<h3 style="text-align: left;">







verifyMarkerCode</h3>
<div style="text-align: left;">
This function first checks the validation branches and then calculates the checksum as shown below:
<br />
<pre> public Boolean verifyMarkerCode(){
  Boolean valid = false;
  if (verifyValidationBranches())
   valid = verifyChecksum();
  return valid;
 }
</pre>
</div>
<div style="text-align: left;">
<br /></div>
<div style="text-align: left;">
<h3 style="text-align: left;">





verifyValidationBranches</h3>
</div>
<div style="text-align: left;">
This function simply checks if the d-touch marker code has number of validation branches as mentioned in the preferences class. The code is shown below:<br />
<pre> private boolean verifyValidationBranches(){
  boolean valid = false;
  int numberOfValidationBranches = 0;
  for (int code : markerCodes){
   if (code == mPreference.getValidationBranchLeaves()){
    numberOfValidationBranches++;
   }
  }
  if (numberOfValidationBranches &gt;= mPreference.getValidationBranches())
   valid = true;
  return valid;
 }
</pre>
<br />
<h3 style="text-align: left;">




verifyChecksum</h3>
<div style="text-align: left;">
This function first calculates the total number of leaves in a d-touch code by simply adding all the numbers in a code. For example if a code is 1:1:1:1:2:4:4:6 then the total number of leaves in the marker are 1+1+1+1+2+4+4+6 = 20.&nbsp; It divides the total sum by the checksum modulo. If the mod is zero then it means the checksum of the code is valid. The function is implemented as follows:
<br />
<pre> private boolean verifyChecksum(){
  boolean valid = false;
  int numberOfLeaves = 0;
  for (int code: markerCodes){
   numberOfLeaves += code;
  }
  if (mPreference.getChecksumModulo() &gt; 0){
   double checksum = numberOfLeaves % mPreference.getChecksumModulo();
   if (checksum == 0){
    valid = true;
   }
  }
  return valid;
 }
</pre>
</div>
<div style="text-align: left;">
&nbsp; I hope this documentation is helpful to understand the d-touch mobile library. If you would like to see the d-touch mobile library in action then please check the code deployed on the <a href="https://github.com/horizon-institute/tableware">github</a> website. </div>
</div>
</div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Tableware maintained by <a href="https://github.com/horizon-institute">horizon-institute</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
